<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continental Rail Company - Evidence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #18120c;
        }
        .book-page {
            box-shadow: 0 0 18px 3px #e6c97a33, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6;
            border-radius: 16px;
            transition: box-shadow 0.5s;
            animation: glow 3s infinite alternate;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 12px 2px #e6c97a22, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6; }
            100% { box-shadow: 0 0 22px 6px #ffe08a44, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6; }
        }
        .main-title h1 {
            color: #bfa14a;
            text-shadow: 0 2px 8px #fffbe6, 0 0 2px #bfa14a;
            letter-spacing: 2px;
            font-size: 2.2em;
            margin-bottom: 0.2em;
        }
        .main-title .subtitle {
            color: #bfa14a;
            font-style: italic;
            font-size: 1.1em;
            margin-bottom: 0.5em;
        }
        .main-title .tagline {
            color: #bfa14a;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 1em;
        }
        .logo-container {
            filter: drop-shadow(0 0 8px #ffe08a88);
            margin-bottom: 0.5em;
        }
        .border-decoration {
            border: 2.5px solid #bfa14a;
            box-shadow: 0 0 16px 2px #e6c97a44;
            border-radius: 12px;
            background: linear-gradient(135deg, #fffbe6 90%, #f7e7b6 100%);
        }
        .book-nav .section-label {
            color: #bfa14a;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 0.5em;
        }
        .book-nav ul li a {
            color: #18120c;
            background: linear-gradient(90deg, #ffe08a 0%, #fffbe6 100%);
            border-radius: 6px;
            padding: 0.2em 0.8em;
            margin: 0.2em 0;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 1px 4px #e6c97a33;
            transition: background 0.2s, color 0.2s;
        }
        .book-nav ul li a:hover {
            background: #bfa14a;
            color: #fffbe6;
        }
    </style>
</head>
<body>
    <div id="login-modal" class="modal" style="display:flex;align-items:center;justify-content:center;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(24,18,12,0.92);">
        <div class="modal-content" style="text-align:center;max-width:350px;margin:auto;background:#fffbe6;border:2px solid #bfa14a;border-radius:12px;padding:2em 2em 1.5em 2em;box-shadow:0 0 24px #bfa14a55;">
            <img src="logo.png" alt="Logo CRC" style="width:80px;margin-bottom:1em;filter:drop-shadow(0 0 8px #ffe08a88);">
            <h2 style="color:#bfa14a;letter-spacing:1px;">Přihlášení přes Discord</h2>
            <p style="margin-bottom:1.5em;">Pro vstup do evidence je nutné ověření identity.</p>
            <button id="discord-login-btn" style="background:#5865F2;color:#fff;font-weight:bold;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1.1em;cursor:pointer;box-shadow:0 2px 8px #5865f255;">Přihlásit se přes Discord</button>
            <div id="login-error" style="color:#b30000;margin-top:1em;display:none;"></div>
        </div>
    </div>
    <div id="main-content" style="display:none;">
        <div class="book-page">
            <div class="border-decoration">
                <header class="main-title">
                    <p class="subtitle">Založeno léta páně 1899</p>
                    <div class="logo-container">
                        <img src="logo.png" alt="Logo CRC" class="logo">
                    </div>
                    <h1>Continental Rail Company</h1>
                    <p class="tagline">Páteř pokroku, tepna civilizace</p>
                    <p class="intro">Vítejte v evidenci zaměstnanců železniční společnosti. Vyberte svého zaměstnance a začněte směnu.</p>
                </header>
                <nav class="book-nav">
                    <p class="section-label">Výběr zaměstnance</p>
                    <ul>
                        <li><a href="postava.html?id=Joshue-Thorne">Joshue Thorne</a></li>
                        <li><a href="postava.html?id=Elizabeth-Brown">Elizabeth Brown</a></li>
                        <li><a href="postava.html?id=Henry-Brown">Henry Brown</a></li>
                        <li><a href="postava.html?id=Nicholas-Carter">Nicholas Carter</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

        <!-- Changelog Modal -->
        <div id="changelog-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeChangelog()">&times;</span>
                <h2>Changelog - Continental Rail Company</h2>
                <table class="changelog-table">
                    <thead>
                        <tr>
                            <th>Verze</th>
                            <th>Změny</th>
                            <th>Přečteno</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2.5</td>
                            <td>Přidána funkce Smluvní přeprava: Formulář pro zadání typu přepravy, počtu položek a poznámek s automatickým výpočtem ceny a odesláním reportu.</td>
                            <td><input type="checkbox" id="v2.5" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.4</td>
                            <td>Přidány poznámky k trasám: LOCAL TRAIN (žádná omezení), EXPRES/BULLET TRAIN (omezení v MacFarlane's Ranch kvůli vlkům).</td>
                            <td><input type="checkbox" id="v2.4" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.3</td>
                            <td>Přidána funkce průvodčích: Po dokončení jízdy výběr průvodčího s odesláním reportu na jeho Discord webhook (služba, prodané jízdenky).</td>
                            <td><input type="checkbox" id="v2.3" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.2</td>
                            <td>Aktualizace tras vlaků: EXPRES TRAIN (nové intervaly bez Oil Fields, s extra časy pro náklad), BULLET TRAIN (nová trasa s Olejárkou) a LOCAL TRAIN (zkrácené časy s extra pro Valentine a Saint Denis).</td>
                            <td><input type="checkbox" id="v2.2" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.1</td>
                            <td>Přidány osobní reporty zaměstnanců na Discord s kumulovanými statistikami. Uložení dat do localStorage pro trvalé sledování.</td>
                            <td><input type="checkbox" id="v2.1" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>1.1</td>
                            <td>Vylepšený vizuál s retro fonty a zlatými akcenty. Přidány ornamenty a animace.</td>
                            <td><input type="checkbox" id="v1.1" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>1.0</td>
                            <td>Počáteční vydání s výběrem zaměstnanců a správou směn.</td>
                            <td><input type="checkbox" id="v1.0" onchange="checkChangelog()"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="rp-button" onclick="closeChangelog()">Zavřít</button>
            </div>
        </div>
    </div>

    <script>
        // Discord OAuth2 přihlášení a omezení přístupu
        const ALLOWED_IDS = [
            "417061947759001600", // Joshu Thorn
            "1350594297250185331", // Henry Brown
            "1454130138240520407", // Elizabeth Brown
            "808315254396289057"   // Nicholas Carter
        ];

        function showError(msg) {
            document.getElementById('login-error').innerText = msg;
            document.getElementById('login-error').style.display = 'block';
        }

        function showMain() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        // Zpracování OAuth2 redirectu
        async function handleDiscordLogin() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('code')) {
                try {
                    // Výměna code za token musí proběhnout na backendu/serverless (zde pouze ukázka postupu)
                    // Backend endpoint by měl přijmout code a vrátit user info
                    // ZDE JE DEMO, V REÁLU NEDÁVEJ DISCORD SECRET DO FRONTENDU!
                    const code = params.get('code');
                    const redirect_uri = encodeURIComponent('https://nov-web-eight.vercel.app/');
                    // V produkci použij serverless funkci!
                    const data = new URLSearchParams();
                    data.append('client_id', '1467553835211030674');
                    data.append('client_secret', ''); // ZDE VLOŽIT SECRET NA BACKENDU!
                    data.append('grant_type', 'authorization_code');
                    data.append('code', code);
                    data.append('redirect_uri', 'https://nov-web-eight.vercel.app/');
                    // fetch('https://discord.com/api/oauth2/token', { method: 'POST', body: data, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })
                    //   .then(...)
                    // Po získání access_tokenu:
                    // fetch('https://discord.com/api/users/@me', { headers: { Authorization: 'Bearer ' + access_token } })
                    //   .then(...)
                    // Zde pouze simulace:
                    // const user = { id: "417061947759001600", username: "Joshu Thorn" };
                    // if (!ALLOWED_IDS.includes(user.id)) { showError('Přístup odepřen. Nejste na seznamu zaměstnanců.'); return; }
                    // showMain();
                    // window.history.replaceState(null, '', window.location.pathname);
                } catch (e) {
                    showError('Chyba při ověřování Discord účtu.');
                }
            }
        }

        document.getElementById('discord-login-btn').onclick = function() {
            const client_id = '1467553835211030674';
            const redirect_uri = encodeURIComponent('https://nov-web-eight.vercel.app/');
            const scope = 'identify';
            const url = `https://discord.com/oauth2/authorize?client_id=${client_id}&response_type=code&redirect_uri=${redirect_uri}&scope=${scope}`;
            window.location.href = url;
        };

        window.onload = function() {
            handleDiscordLogin();
            if (!sessionStorage.getItem('changelogShown')) {
                document.getElementById('changelog-modal').style.display = 'block';
                sessionStorage.setItem('changelogShown', 'true');
            }
        };

        function closeChangelog() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        function checkChangelog() {
            // Optional: save to localStorage if all checked
            const checks = document.querySelectorAll('#changelog-modal input[type="checkbox"]');
            const allChecked = Array.from(checks).every(cb => cb.checked);
            if (allChecked) {
                localStorage.setItem('changelogRead', 'true');
            }
        }
    </script>
</body>
</html>