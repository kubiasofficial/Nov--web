<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continental Rail Company - Evidence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #18120c;
        }
        .book-page {
            box-shadow: 0 0 18px 3px #e6c97a33, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6;
            border-radius: 16px;
            transition: box-shadow 0.5s;
            animation: glow 3s infinite alternate;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 12px 2px #e6c97a22, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6; }
            100% { box-shadow: 0 0 22px 6px #ffe08a44, 0 0 0 2.5px #bfa14a, 0 0 0 5px #fffbe6; }
        }
        .main-title h1 {
            color: #bfa14a;
            text-shadow: 0 2px 8px #fffbe6, 0 0 2px #bfa14a;
            letter-spacing: 2px;
            font-size: 2.2em;
            margin-bottom: 0.2em;
        }
        .main-title .subtitle {
            color: #bfa14a;
            font-style: italic;
            font-size: 1.1em;
            margin-bottom: 0.5em;
        }
        .main-title .tagline {
            color: #bfa14a;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 1em;
        }
        .logo-container {
            filter: drop-shadow(0 0 8px #ffe08a88);
            margin-bottom: 0.5em;
        }
        .border-decoration {
            border: 2.5px solid #bfa14a;
            box-shadow: 0 0 16px 2px #e6c97a44;
            border-radius: 12px;
            background: linear-gradient(135deg, #fffbe6 90%, #f7e7b6 100%);
        }
        .book-nav .section-label {
            color: #bfa14a;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 0.5em;
        }
        .book-nav ul li a {
            color: #18120c;
            background: linear-gradient(90deg, #ffe08a 0%, #fffbe6 100%);
            border-radius: 6px;
            padding: 0.2em 0.8em;
            margin: 0.2em 0;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 1px 4px #e6c97a33;
            transition: background 0.2s, color 0.2s;
        }
        .book-nav ul li a:hover {
            background: #bfa14a;
            color: #fffbe6;
        }
    </style>
</head>
<body>
    <div id="login-modal" class="modal" style="display:flex;align-items:center;justify-content:center;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(24,18,12,0.92);">
        <div class="modal-content" style="text-align:center;max-width:350px;margin:auto;background:#fffbe6;border:2px solid #bfa14a;border-radius:12px;padding:2em 2em 1.5em 2em;box-shadow:0 0 24px #bfa14a55;">
            <img src="logo.png" alt="Logo CRC" style="width:80px;margin-bottom:1em;filter:drop-shadow(0 0 8px #ffe08a88);">
            <h2 style="color:#bfa14a;letter-spacing:1px;">Přihlášení přes Discord</h2>
            <p style="margin-bottom:1.5em;">Pro vstup do evidence je nutné ověření identity.</p>
            <button id="discord-login-btn" style="background:#5865F2;color:#fff;font-weight:bold;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1.1em;cursor:pointer;box-shadow:0 2px 8px #5865f255;">Přihlásit se přes Discord</button>
            <div id="login-error" style="color:#b30000;margin-top:1em;display:none;"></div>
        </div>
    </div>
    <div id="main-content" style="display:none;">
        <div class="book-page">
            <div class="border-decoration">
                <header class="main-title">
                    <p class="subtitle">Založeno léta páně 1899</p>
                    <div class="logo-container">
                        <img src="logo.png" alt="Logo CRC" class="logo">
                    </div>
                    <h1>Continental Rail Company</h1>
                    <p class="tagline">Páteř pokroku, tepna civilizace</p>
                </header>
                <div id="zamestnanec-info" style="margin:2em 0 1em 0;"></div>
                <!-- Další obsah (tlačítka, menu) můžeš přidat sem -->
            </div>
        </div>
    </div>

        <!-- Changelog Modal -->
        <div id="changelog-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeChangelog()">&times;</span>
                <h2>Changelog - Continental Rail Company</h2>
                <table class="changelog-table">
                    <thead>
                        <tr>
                            <th>Verze</th>
                            <th>Změny</th>
                            <th>Přečteno</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2.7</td>
                            <td>
                                <ul>
                                    <li>Detailní stav zaměstnanců: v seznamu vidíte, kdo právě jede, na jaké trase a s jakou lokomotivou.</li>
                                    <li>Historie jízd v detailu zaměstnance (tabulka posledních jízd).</li>
                                    <li>Seznam zaměstnanců se automaticky aktualizuje v reálném čase.</li>
                                </ul>
                            </td>
                            <td><input type="checkbox" id="v2.7" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.6</td>
                            <td>
                                <ul>
                                    <li>Real-time aktualizace obsazenosti lokomotivy (automatické změny bez F5).</li>
                                    <li>Jízdní řád se generuje vždy od času, kdy je vlak dostupný (manuální i turnusová jízda).</li>
                                    <li>Vylepšená logika pro blokaci a uvolnění vlaku, uživatelsky přívětivé hlášky.</li>
                                </ul>
                            </td>
                            <td><input type="checkbox" id="v2.6" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.5</td>
                            <td>Přidána funkce Smluvní přeprava: Formulář pro zadání typu přepravy, počtu položek a poznámek s automatickým výpočtem ceny a odesláním reportu.</td>
                            <td><input type="checkbox" id="v2.5" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.4</td>
                            <td>Přidány poznámky k trasám: LOCAL TRAIN (žádná omezení), EXPRES/BULLET TRAIN (omezení v MacFarlane's Ranch kvůli vlkům).</td>
                            <td><input type="checkbox" id="v2.4" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.3</td>
                            <td>Přidána funkce průvodčích: Po dokončení jízdy výběr průvodčího s odesláním reportu na jeho Discord webhook (služba, prodané jízdenky).</td>
                            <td><input type="checkbox" id="v2.3" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.2</td>
                            <td>Aktualizace tras vlaků: EXPRES TRAIN (nové intervaly bez Oil Fields, s extra časy pro náklad), BULLET TRAIN (nová trasa s Olejárkou) a LOCAL TRAIN (zkrácené časy s extra pro Valentine a Saint Denis).</td>
                            <td><input type="checkbox" id="v2.2" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>2.1</td>
                            <td>Přidány osobní reporty zaměstnanců na Discord s kumulovanými statistikami. Uložení dat do localStorage pro trvalé sledování.</td>
                            <td><input type="checkbox" id="v2.1" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>1.1</td>
                            <td>Vylepšený vizuál s retro fonty a zlatými akcenty. Přidány ornamenty a animace.</td>
                            <td><input type="checkbox" id="v1.1" onchange="checkChangelog()"></td>
                        </tr>
                        <tr>
                            <td>1.0</td>
                            <td>Počáteční vydání s výběrem zaměstnanců a správou směn.</td>
                            <td><input type="checkbox" id="v1.0" onchange="checkChangelog()"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="rp-button" onclick="closeChangelog()">Zavřít</button>
            </div>
        </div>
    </div>

    <script>
        // Discord OAuth2 přihlášení a omezení přístupu
        const ALLOWED_IDS = [
            "417061947759001600", // Joshu Thorn
            "1350594297250185331", // Henry Brown
            "1454130138240520407", // Elizabeth Brown
            "808315254396289057"   // Nicholas Carter
        ];

        function showError(msg) {
            document.getElementById('login-error').innerText = msg;
            document.getElementById('login-error').style.display = 'block';
        }

        function showMain() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            // Ladicí výpisy a zobrazení chyb
            console.log('showMain start', sessionStorage.getItem('discordUser'));
            import('./firebase.js').then(async ({ db }) => {
                try {
                    const { doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                    const user = JSON.parse(sessionStorage.getItem('discordUser'));
                    console.log('Discord user:', user);
                    if (user) {
                        const ref = doc(db, "zamestnanci", user.id);
                        let snap = await getDoc(ref);
                        console.log('Firestore snap exists:', snap.exists());
                        if (!snap.exists()) {
                            // Vytvořit nový dokument s výchozími hodnotami
                            await setDoc(ref, {
                                jmeno: user.username,
                                status: "volno",
                                pocetJizd: 0,
                                trzba: 0,
                                aktualniTrasa: "-",
                                avatar: user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : "-",
                                role: "strojvedoucí",
                                posledniJizda: {
                                    Vydelano: 0,
                                    datum: serverTimestamp(),
                                    trasa: "-",
                                    typ: "-"
                                }
                            });
                            snap = await getDoc(ref);
                            console.log('Nový dokument vytvořen.');
                        }
                        if (snap.exists()) {
                            const data = snap.data();
                            console.log('Načtená data zaměstnance:', data);
                            document.getElementById('zamestnanec-info').innerHTML = `
                                <h2 style=\"color:#bfa14a;margin-bottom:0.2em;\">${data.jmeno} <span style=\"font-size:0.7em;color:#888;\">(${user.id})</span></h2>
                                <div style=\"margin-bottom:1.2em;\">Role: <b>${data.role}</b></div>
                                <div style=\"margin-bottom:0.7em;\"><b>Status:</b> <span style=\"color:${data.status==='v praci'?'#2ecc71':'#bfa14a'};font-weight:bold;\">${data.status==='v praci'?'V práci':'Volno'}</span></div>
                                <div style=\"margin-bottom:0.7em;\"><b>Počet odjetých jízd:</b> ${data.pocetJizd}</div>
                                <div style=\"margin-bottom:0.7em;\"><b>Celková tržba:</b> ${data.trzba} $</div>
                                <div style=\"margin-bottom:0.7em;\"><b>Aktuální trasa:</b> ${data.aktualniTrasa || '-'}</div>
                                <div style=\"margin-top:1.2em;\"><b>Poslední jízda:</b><br>
                                    <span style=\"font-size:0.95em;\">
                                    Datum: <b>${data.posledniJizda && data.posledniJizda.datum && data.posledniJizda.datum.seconds ? new Date(data.posledniJizda.datum.seconds * 1000).toLocaleString() : '-'}</b><br>
                                    Trasa: <b>${data.posledniJizda && data.posledniJizda.trasa ? data.posledniJizda.trasa : '-'}</b><br>
                                    Typ: <b>${data.posledniJizda && data.posledniJizda.typ ? data.posledniJizda.typ : '-'}</b><br>
                                    Výdělek: <b>${data.posledniJizda && data.posledniJizda.Vydelano ? data.posledniJizda.Vydelano : 0} $</b>
                                    </span>
                                </div>
                                <div style=\"margin-top:2em;display:flex;gap:1.2em;justify-content:center;\">
                                    <a href=\"postava.html?id=${encodeURIComponent(data.jmeno.replace(/ /g, '-'))}\" class=\"rp-button\" style=\"background:#bfa14a;color:#18120c;font-weight:bold;padding:0.7em 2em;border-radius:7px;text-decoration:none;box-shadow:0 2px 8px #bfa14a33;transition:background 0.2s;\">Začít</a>
                                    <a href=\"zamestnanci.html\" class=\"rp-button\" style=\"background:#fffbe6;color:#bfa14a;font-weight:bold;padding:0.7em 2em;border-radius:7px;text-decoration:none;box-shadow:0 2px 8px #bfa14a33;transition:background 0.2s;border:1.5px solid #bfa14a;\">Zaměstnanci</a>
                                </div>
                            `;
                        } else {
                            document.getElementById('zamestnanec-info').innerText = 'Zaměstnanec nenalezen v databázi.';
                            console.error('Zaměstnanec nenalezen v databázi.');
                        }
                    } else {
                        document.getElementById('zamestnanec-info').innerText = 'Chyba: Discord uživatel nenalezen v sessionStorage.';
                        console.error('Chyba: Discord uživatel nenalezen v sessionStorage.');
                    }
                } catch (err) {
                    document.getElementById('zamestnanec-info').innerText = 'Chyba při načítání zaměstnance: ' + err;
                    console.error('Chyba při načítání zaměstnance:', err);
                }
            });
        }

        // Zpracování OAuth2 redirectu
        async function handleDiscordLogin() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('code')) {
                try {
                    const code = params.get('code');
                    // Odeslat code na backendovou funkci
                    const resp = await fetch('/api/discord-auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code })
                    });
                    const result = await resp.json();
                    if (!result.user || !result.user.id) {
                        showError('Nepodařilo se ověřit Discord účet.');
                        return;
                    }
                    // Kontrola povolených ID
                    if (!ALLOWED_IDS.includes(result.user.id)) {
                        showError('Přístup odepřen. Nejste na seznamu zaměstnanců.');
                        return;
                    }
                    // Uložit uživatele do localStorage/sessionStorage dle potřeby
                    sessionStorage.setItem('discordUser', JSON.stringify(result.user));
                    showMain();
                    // Vyčistit URL od code parametru
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (e) {
                    showError('Chyba při ověřování Discord účtu.');
                }
            }
        }

        document.getElementById('discord-login-btn').onclick = function() {
            const client_id = '1467553835211030674';
            const redirect_uri = encodeURIComponent('https://nov-web-eight.vercel.app/');
            const scope = 'identify';
            const url = `https://discord.com/oauth2/authorize?client_id=${client_id}&response_type=code&redirect_uri=${redirect_uri}&scope=${scope}`;
            window.location.href = url;
        };

        window.onload = function() {
            // Pokud je uživatel uložen v sessionStorage, rovnou zobraz hlavní obsah
            const user = sessionStorage.getItem('discordUser');
            if (user) {
                showMain();
            } else {
                handleDiscordLogin();
            }
            if (!sessionStorage.getItem('changelogShown')) {
                document.getElementById('changelog-modal').style.display = 'block';
                sessionStorage.setItem('changelogShown', 'true');
            }
        };

        function closeChangelog() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        function checkChangelog() {
            // Optional: save to localStorage if all checked
            const checks = document.querySelectorAll('#changelog-modal input[type="checkbox"]');
            const allChecked = Array.from(checks).every(cb => cb.checked);
            if (allChecked) {
                localStorage.setItem('changelogRead', 'true');
            }
        }
    </script>
</body>
<script type="module">
    import { db } from './firebase.js';
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    async function nactiZamestnance(discordId) {
        const ref = doc(db, "zamestnanci", discordId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            return snap.data();
        } else {
            return null;
        }
    }

    // Příklad použití:
    // const user = JSON.parse(sessionStorage.getItem('discordUser'));
    // if (user) nactiZamestnance(user.id).then(data => console.log(data));
</script>
</html>