<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pracovn√≠ list - CRC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="book-page">
        <div class="border-decoration">
            <header>
                <h1 id="jmeno-zamestnance">Naƒç√≠t√°n√≠...</h1>
                <div class="ornament">‚ù¶</div>
            </header>

            <div id="hlavni-rozhrani">
                <div class="status-box">
                    <p id="aktualni-stav">Status: Mimo slu≈æbu</p>
                </div>
                <div class="button-container">
                    <button class="rp-button" onclick="zobrazNastaveniSmeny()">Zaƒç√≠t Smƒõnu (Manu√°ln√≠)</button>
                    <button class="rp-button" onclick="zobrazVyberSmeny()">P≈ôebrat smƒõnu (Turnus)</button>
                    <button class="rp-button" onclick="zobrazSmluvniPrepravu()">Smluvn√≠ p≈ôeprava</button>
                    <button class="rp-button btn-reset" onclick="vymazatZaznam()">Resetovat data</button>
                    <button class="rp-button btn-reset" onclick="resetObsazenostLokomotivy()">Reset obsazenosti lokomotivy</button>
                </div>
            </div>

            <div id="smluvni-preprava" style="display:none;">
                <h2 class="section-label">Smluvn√≠ p≈ôeprava</h2>
                <div class="button-container">
                    <label class="rp-label">Typ p≈ôepravy:</label>
                    <select id="typ-prepravy" class="rp-select">
                        <option value="osobn√≠">Osobn√≠</option>
                        <option value="n√°kladn√≠">N√°kladn√≠</option>
                    </select>
                    <label class="rp-label">Poƒçet osob:</label>
                    <input type="number" id="pocet-osob" class="rp-input" min="0" value="0">
                    <label class="rp-label">Poƒçet zv√≠≈ôat:</label>
                    <input type="number" id="pocet-zvirat" class="rp-input" min="0" value="0">
                    <label class="rp-label">Bƒõ≈æn√Ω n√°klad (kg/kus):</label>
                    <input type="number" id="bezny-naklad" class="rp-input" min="0" value="0">
                    <label class="rp-label">N√°klad zv√Ω≈°en√© hodnoty (kg/kus):</label>
                    <input type="number" id="zvyseny-naklad" class="rp-input" min="0" value="0">
                    <label class="rp-label">Pron√°jem vlaku (hodiny):</label>
                    <input type="number" id="pronajem-hodiny" class="rp-input" min="0" value="0">
                    <label class="rp-label">Pozn√°mka:</label>
                    <textarea id="poznamka-preprava" class="rp-input" rows="3"></textarea>
                    <button class="rp-button" onclick="odeslatSmluvniPrepravu()">Odeslat smluvn√≠ p≈ôepravu</button>
                    <button class="back-link" onclick="zpet()">‚Üê Zpƒõt</button>
                </div>
            </div>

            <div id="vyber-turnusu" style="display:none;">
                <h2 class="section-label">Volba slu≈æby</h2>
                <div class="button-container">
                    <button class="rp-button" onclick="nastavitTurnus('RANN√ç')">¬ß RANN√ç (05:00 - 15:00)</button>
                    <button class="rp-button" onclick="nastavitTurnus('ODPOLEDN√ç')">¬ß ODPOLEDN√ç (15:00 - 22:00)</button>
                    <button class="rp-button" onclick="nastavitTurnus('NOƒåN√ç')">¬ß NOƒåN√ç (22:00 - 05:00)</button>
                    <button class="back-link" onclick="zpet()">‚Üê Zpƒõt</button>
                </div>
            </div>

            <div id="vyber-linky" style="display:none;">
                <h2 class="section-label">Nastaven√≠ j√≠zdy</h2>
                <div class="button-container">
                    <label class="rp-label">Linka:</label>
                    <select id="select-linka" class="rp-select">
                        <option value="0">Expres Train (Dlouh√° trasa)</option>
                        <option value="1">Bullet Train (Rychl√≠k)</option>
                        <option value="2">Local Train (Region√°ln√≠)</option>
                    </select>
                    <label class="rp-label">Poƒçet kol:</label>
                    <input type="number" id="input-kola" class="rp-input" min="1" value="1">
                    <label class="rp-label">Odjezd za (minut):</label>
                    <input type="number" id="input-odklad" class="rp-input" min="0" value="0">
                    <button class="rp-button" onclick="zah√°jitManualniSmenu()">Potvrdit a vyjet</button>
                    <button class="back-link" onclick="zpet()">‚Üê Zpƒõt</button>
                </div>
            </div>

            <div id="jizdni-rad-smeny" style="display:none;">
                <h2 class="section-label">J√≠zdn√≠ ≈ô√°d</h2>
                <div id="vypis-linek" class="jizdy-list"></div>
                <button id="finish-btn" class="rp-button btn-finish-shift" onclick="ukoncitSmenu()">UKONƒåIT CELOU SMƒöNU</button>
            </div>

            <footer><a href="index.html" class="back-link">Zpƒõt do seznamu</a></footer>
        </div>
    </div>

    <script>
                // TESTOVAC√ç funkce pro ruƒçn√≠ odemknut√≠ lokomotivy (reset obsazenosti)
                async function resetObsazenostLokomotivy() {
                    try {
                        const { db } = await import('./firebase.js');
                        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                        await setDoc(doc(db, "lokomotivy", "lokomotiva_1"), {
                            obsazeno: false,
                            trasa: "-",
                            zamestnanecId: "-",
                            konecJizdy: null,
                            zmeneno: new Date()
                        }, { merge: true });
                        alert('Obsazenost lokomotivy byla resetov√°na.');
                    } catch (e) {
                        alert('Chyba p≈ôi resetu obsazenosti: ' + (e.message || e));
                    }
                }
        const params = new URLSearchParams(window.location.search);
        const postavaID = params.get('id');
        const jmenoZamestnance = postavaID ? postavaID.replace(/-/g, ' ') : "Nezn√°m√Ω";
        document.getElementById('jmeno-zamestnance').innerText = jmenoZamestnance;

        const WEBHOOK_HLAVNI = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
        const WEBHOOK_BLACKWATER = "https://discord.com/api/webhooks/1463245037834862616/M_myizEOqBJjE84_5MKqNQdRlY4S1P6EHBA3JnYxOw2mdYYn0kt609sc8MIz1v3e4PkV";

        const WEBHOOK_JIZDNI_RAD = "https://discord.com/api/webhooks/1462391755864277033/mQ1n6EsyC-yEuEc7hZTYsm8Jt9VjnUGr-jPVM2qjvVSSkisoS2Cpl1DSi1Oe7lUnBd6J";

        const WEBHOOK_ZAMESTNANCI = {
            'Joshue-Thorne': "https://discord.com/api/webhooks/1465056082752704603/RLXTppqZ_ANNJ58G7SAnJt9jzupt1ySDpeuz3TcgZUnGIoWeEYH4iRe9uAgw2pugZUbo",
            'Elizabeth-Brown': "https://discord.com/api/webhooks/1465055695148945479/XbFSoeTQ7uvPyO_9dzfaRzXU8Vs_A0rxEtj2KhD14cmzhB6CE0lJyk0eEtrpF9MBgRwD",
            'Henry-Brown': "https://discord.com/api/webhooks/1465055928955965726/b2yx37bmObtgQkbuh-8RLX4OmGuNLb55T_ZoqKnP33wV22tvv_Hkq2viyb5H7gbt3b6R",
            'Nicholas-Carter': "https://discord.com/api/webhooks/1465055817861435568/4ewqq4dEVmRgdcj86YCudaB5l34CMg8BiMHHvt_T-mfsUJSQ3T_ofibyBKK29pqqvEP-"
        };

        let statistiky = { dokonƒçeno: 0, celkemTrasy: 0, trzba: 0 };
        
        // Data upravena podle tv√Ωch nejnovƒõj≈°√≠ch tras a k≈ôi≈æov√°n√≠ v Olej√°rnƒõ
        const linkyData = [
            { 
                nazev: "EXPRES TRAIN", 
                doba: 67, // Upraven√° doba podle nov√Ωch interval≈Ø
                zastavky: [
                    {s: "Saint Denis", t: 0}, {s: "Van Horn", t: 3}, {s: "Annesburg", t: 8}, 
                    {s: "Bacchus Station", t: 4}, {s: "Wallace Station", t: 4}, {s: "Riggs Station", t: 2}, 
                    {s: "Blackwater", t: 2}, {s: "MacFarlane's Ranch", t: 4}, {s: "Armadillo", t: 4}, 
                    {s: "Mercer Station", t: 2}, {s: "Benedict Point", t: 12}, {s: "Mercer Station", t: 3}, 
                    {s: "Armadillo", t: 2}, {s: "MacFarlane's Ranch", t: 4}, {s: "Blackwater", t: 4}, 
                    {s: "Flatneck", t: 3}, {s: "Rhodes", t: 3}, {s: "Saint Denis", t: 3}
                ] 
            },
            { 
                nazev: "BULLET TRAIN", 
                doba: 37, // Upraven√° doba podle nov√Ωch interval≈Ø
                zastavky: [
                    {s: "Saint Denis", t: 0}, {s: "Oil Fields", t: 4}, {s: "Valentine", t: 2}, {s: "Flatneck Station", t: 2}, 
                    {s: "Montana River", t: 4}, {s: "MacFarlane's Ranch", t: 8}, {s: "Blackwater", t: 3}, {s: "Flatneck Station", t: 2}, 
                    {s: "Rhodes", t: 3}, {s: "Saint Denis", t: 9}
                ] 
            },
            { 
                nazev: "LOCAL TRAIN", 
                doba: 13, // Nov√° doba podle zad√°n√≠ (3+3+4+3)
                zastavky: [
                    {s: "Saint Denis", t: 0},
                    {s: "Saint Denis (pobyt telegramy)", t: 3},
                    {s: "Rhodes", t: 3},
                    {s: "Valentine", t: 3},
                    {s: "Valentine (pobyt vykl./nakl.)", t: 6},
                    {s: "Emerald Ranch", t: 4},
                    {s: "Saint Denis", t: 3}
                ],
                poznamka: "Nab√≠r√°me telegramy v Saint Denis (+3 min) a vykl√°d√°me/nakl√°d√°me ve Valentine (+6 min)."
            }
        ];

        const SMENY_CONFIG = {
            'RANN√ç': { start: 300, konec: 900 },    // 05:00 - 15:00
            'ODPOLEDN√ç': { start: 900, konec: 1320 }, // 15:00 - 22:00
            'NOƒåN√ç': { start: 1320, konec: 1740 }   // 22:00 - 05:00
        };

        function formatCas(h, m) {
            let hh = h; while (hh >= 24) hh -= 24;
            return (hh < 10 ? "0"+hh : hh) + ":" + (m < 10 ? "0"+m : m);
        }

        function zobrazNastaveniSmeny() { 
            document.getElementById('hlavni-rozhrani').style.display='none'; 
            document.getElementById('vyber-linky').style.display='block'; 
        }

        function zobrazVyberSmeny() {
            document.getElementById('hlavni-rozhrani').style.display='none';
            document.getElementById('vyber-turnusu').style.display='block';
        }

        function zobrazSmluvniPrepravu() {
            document.getElementById('hlavni-rozhrani').style.display='none';
            document.getElementById('smluvni-preprava').style.display='block';
        }

        function zpet() { location.reload(); }

        async function odeslatSmluvniPrepravu() {
            const typ = document.getElementById('typ-prepravy').value;
            const osob = parseInt(document.getElementById('pocet-osob').value) || 0;
            const zvirat = parseInt(document.getElementById('pocet-zvirat').value) || 0;
            const bezny = parseInt(document.getElementById('bezny-naklad').value) || 0;
            const zvyseny = parseInt(document.getElementById('zvyseny-naklad').value) || 0;
            const hodiny = parseInt(document.getElementById('pronajem-hodiny').value) || 0;
            const poznamka = document.getElementById('poznamka-preprava').value;

            // Spoƒç√≠tat cenu
            const cenaOsob = osob * 5;
            const cenaZvirat = zvirat * 3;
            const cenaBezny = bezny * 0.5;
            const cenaZvyseny = zvyseny * 1.5;
            const cenaPronajem = hodiny * 500;
            const total = cenaOsob + cenaZvirat + cenaBezny + cenaZvyseny + cenaPronajem;

            // Detail p≈ôepravy
            let detail = '';
            if (osob > 0) detail += `${osob} osob, `;
            if (zvirat > 0) detail += `${zvirat} zv√≠≈ôat, `;
            if (bezny > 0) detail += `${bezny} kg/kus bƒõ≈æn√©ho n√°kladu, `;
            if (zvyseny > 0) detail += `${zvyseny} kg/kus n√°kladu zv√Ω≈°en√© hodnoty, `;
            if (hodiny > 0) detail += `${hodiny} hodin pron√°jmu, `;
            detail = detail.slice(0, -2); // Odstranit posledn√≠ ", "

            // Odeslat na webhook
            const message = `V√Ωkaz smluvn√≠ p≈ôepravy\nStrojvudce ${jmenoZamestnance}\nPr√°vƒõ p≈ôevzal smluvn√≠ p≈ôepravu a vyj√≠≈æd√≠ na trasu. Tento vlak veze ${typ} p≈ôepravu a to p≈ôesnƒõ ${detail}. Pozn√°mka strojvedouc√≠ho: ${poznamka}.\n\nSmluvn√≠ p≈ôeprava ≈Ωelezniƒçn√≠ spoleƒçnosti p≈ôinesla v√Ωdƒõlek ${total}$`;

            await odeslat("https://discord.com/api/webhooks/1465274718012571822/LtfSaI2VDPmRmzvlYfDneQd4S7unna3j9xFXoxhR_9Sd0GrKKLL_B1eNV_uBUjzUdKuj", null, {
                title: "üìã V√Ωkaz smluvn√≠ p≈ôepravy",
                description: message,
                color: 0xffd700
            });

            // Report do osobn√≠ slo≈æky
            const zamWebhook = WEBHOOK_ZAMESTNANCI[postavaID];
            if (zamWebhook) {
                await odeslat(zamWebhook, null, {
                    title: "Smluvn√≠ p≈ôeprava dokonƒçena",
                    description: `**${jmenoZamestnance}** dokonƒçil smluvn√≠ p≈ôepravu. V√Ωdƒõlek: ${total}$.`,
                    color: 0x2ecc71
                });
            }

            alert('Smluvn√≠ p≈ôeprava odesl√°na!');
            location.reload();
        }

        async function nastavitTurnus(typ) {
            const config = SMENY_CONFIG[typ];
            let aktualniCasVMinutach = config.start;
            const konecSmenyVMinutach = config.konec;

            // Kontrola obsazenosti lokomotivy
            const { zjistiObsazenost, zamkniLokomotivu } = await import('./lokomotiva.js');
            const obsaz = await zjistiObsazenost();
            if (obsaz.obsazeno && obsaz.konecJizdy && obsaz.konecJizdy.seconds * 1000 > Date.now()) {
                const dt = new Date(obsaz.konecJizdy.seconds * 1000);
                alert(`Lituji, ale moment√°lnƒõ u≈æ je jeden strojvedouc√≠ na trase. Voln√° lokomotiva bude a≈æ v ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`);
                return;
            }

            // Zamknout lokomotivu pro tuto smƒõnu (do konce smƒõny)
            const konecJizdy = new Date();
            konecJizdy.setHours(Math.floor(konecSmenyVMinutach / 60));
            konecJizdy.setMinutes(konecSmenyVMinutach % 60);
            konecJizdy.setSeconds(0);
            await zamkniLokomotivu({
                trasa: `Turnus ${typ}`,
                zamestnanecId: postavaID,
                konecJizdy: konecJizdy
            });

            document.getElementById('vyber-turnusu').style.display = 'none';
            document.getElementById('jizdni-rad-smeny').style.display = 'block';
            let v = document.getElementById('vypis-linek');
            v.innerHTML = "";

            statistiky.celkemTrasy = 0;
            let indexLinky = 0;

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek smƒõny",
                description: `**${jmenoZamestnance}** nastupuje na turnus: **${typ}**.`,
                color: 0x3498db
            });

            while (aktualniCasVMinutach + 20 < konecSmenyVMinutach) {
                let linka = linkyData[indexLinky % linkyData.length];
                if (aktualniCasVMinutach + linka.doba > konecSmenyVMinutach) break;

                let startH = Math.floor(aktualniCasVMinutach / 60) % 24;
                let startM = aktualniCasVMinutach % 60;

                v.innerHTML += vytvorRadekJizdy(linka, statistiky.celkemTrasy + 1, startH, startM);
                
                aktualniCasVMinutach += linka.doba + 10; // Doba j√≠zdy + 10min pauza v Saint Denis
                statistiky.celkemTrasy++;
                let indexLinky = 0;
            }
        }

        async function zah√°jitManualniSmenu() {
        try {
            const index = document.getElementById('select-linka').value;
            const kola = parseInt(document.getElementById('input-kola').value) || 1;
            const odklad = parseInt(document.getElementById('input-odklad').value) || 0;
            const d = new Date(new Date().getTime() + (odklad * 60000));

            // Kontrola obsazenosti lokomotivy
            const { zjistiObsazenost, zamkniLokomotivu } = await import('./lokomotiva.js');
            const obsaz = await zjistiObsazenost();
            if (obsaz.obsazeno && obsaz.konecJizdy && obsaz.konecJizdy.seconds * 1000 > Date.now()) {
                const dt = new Date(obsaz.konecJizdy.seconds * 1000);
                alert(`Lituji, ale moment√°lnƒõ u≈æ je jeden strojvedouc√≠ na trase. Voln√° lokomotiva bude a≈æ v ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`);
                return;
            }

            // Zamknout lokomotivu pro tuto j√≠zdu
            const konecJizdy = new Date(d.getTime() + (linkyData[index].doba + 10) * 60000 * kola); // orientaƒçnƒõ
            await zamkniLokomotivu({
                trasa: linkyData[index].nazev,
                zamestnanecId: postavaID,
                konecJizdy: konecJizdy
            });

            // Aktualizace statusu a trasy zamƒõstnance (vytvo≈ôen√≠ pokud neexistuje)
            if (!window._firestore_imported) {
                window._firestore_imported = {};
                window._firestore_imported.db = (await import('./firebase.js')).db;
                const firestore = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                window._firestore_imported.doc = firestore.doc;
                window._firestore_imported.updateDoc = firestore.updateDoc;
                window._firestore_imported.setDoc = firestore.setDoc;
                window._firestore_imported.getDoc = firestore.getDoc;
            }
            const docRef = window._firestore_imported.doc(window._firestore_imported.db, "zamestnanci", postavaID);
            const docSnap = await window._firestore_imported.getDoc(docRef);
            if (docSnap.exists()) {
                await window._firestore_imported.updateDoc(docRef, {
                    status: "v praci",
                    aktualniTrasa: linkyData[index].nazev
                });
            } else {
                await window._firestore_imported.setDoc(docRef, {
                    status: "v praci",
                    aktualniTrasa: linkyData[index].nazev
                }, { merge: true });
            }

            document.getElementById('vyber-linky').style.display='none'; 
            document.getElementById('jizdni-rad-smeny').style.display='block';

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek manu√°ln√≠ smƒõny",
                description: `**${jmenoZamestnance}** zahajuje manu√°ln√≠ smƒõnu (${linkyData[index].nazev}).`,
                color: 0x3498db
            });

            let v = document.getElementById('vypis-linek'); v.innerHTML = "";
            let h = d.getHours(), m = d.getMinutes();
            for(let i=1; i<=kola; i++) {
                v.innerHTML += vytvorRadekJizdy(linkyData[index], i, h, m);
                statistiky.celkemTrasy++;
                m += linkyData[index].doba + 10; while(m >= 60) { m -= 60; h++; }
            }
        } catch (e) {
            alert('Nastala chyba p≈ôi zah√°jen√≠ j√≠zdy: ' + (e.message || e));
            console.error(e);
        }
        }

        function vytvorRadekJizdy(l, c, h, m) {
            const id = "j-" + Math.random().toString(36).substr(2, 5);
            const sV = formatCas(h, m);
            let it = `<table class="itinerar-table">`;
            let tH = h, tM = m;
            l.zastavky.forEach(z => {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                it += `<tr><td>${z.s}</td><td class="it-cas">${formatCas(tH, tM)}</td></tr>`;
            });
            it += `</table>`;
            return `<div class="jizda-item" id="item-${id}">
                <p><strong>${c}. ${l.nazev} (${sV})</strong></p>
                <button class="detail-btn" onclick="toggleDetail('${id}')">TRASA</button>
                <button class="start-btn" id="st-${id}" onclick="start('${id}', '${c}', '${sV}', '${formatCas(tH, tM)}', ${JSON.stringify(l).replace(/"/g, '&quot;')}, ${h}, ${m})">ZAƒå√çT J√çZDU</button>
                <button class="check-btn" id="ch-${id}" style="display:none;" onclick="konec('${id}', '${c}', '${l.nazev}')">HOTOVO ‚úî</button>
                <div id="${id}" class="jizda-detail" style="display:none;">${it}</div>
            </div>`;
        }

        async function start(id, c, s, k, lObj, h, m) {
            // Pozn√°mky pro stanice s extra ƒçasem (jen p≈ôi prvn√≠m v√Ωskytu)
            const extraStations = new Set(['Annesburg', 'Benedict Point', "MacFarlane's Ranch", 'Saint Denis', 'Valentine']);
            const usedStations = new Set();

            // Pozn√°mky pro linky
            const poznamky = {
                "EXPRES TRAIN": "Pozor omezen√≠ na trati ve stanici MacFarlane's Ranch. Pokud zde vyd√°v√°te a nebo nab√≠r√°te telegramy v noƒçn√≠ch hodin√°ch i p≈ôes den dbejte zv√Ω≈°en√© opatrnosti mo≈æn√Ω v√Ωskyt vlk≈Ø nebezpeƒç√≠ urazu!!!",
                "BULLET TRAIN": "Pozor omezen√≠ na trati ve stanici MacFarlane's Ranch. Pokud zde vyd√°v√°te a nebo nab√≠r√°te telegramy v noƒçn√≠ch hodin√°ch i p≈ôes den dbejte zv√Ω≈°en√© opatrnosti mo≈æn√Ω v√Ωskyt vlk≈Ø nebezpeƒç√≠ urazu!!!",
                "LOCAL TRAIN": "≈æ√°dn√° omezen√≠ na trati"
            };

            // Vytvo≈ôen√≠ textu j√≠zdn√≠ho ≈ô√°du
            let jizdniRad = `**Strojvedouc√≠:** ${jmenoZamestnance}\n**Linka:** ${lObj.nazev}\n**J√≠zda ƒç.** ${c}\n**Odjezd:** ${s}\n\n**Itiner√°≈ô:**\n`;
            let tH = h, tM = m;
            lObj.zastavky.forEach(z => {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                let note = '';
                if (extraStations.has(z.s) && !usedStations.has(z.s)) {
                    note = ' (n√°klad + vykl√°dka telegramu)';
                    usedStations.add(z.s);
                }
                jizdniRad += `- ${z.s}${note}: ${formatCas(tH, tM)}\n`;
            });

            // P≈ôidat pozn√°mku
            jizdniRad += `\n**Pozn√°mka:** ${poznamky[lObj.nazev] || ''}`;

            await odeslat(WEBHOOK_JIZDNI_RAD, null, {
                title: "üöÇ J√≠zdn√≠ ≈ô√°d - Zaƒç√°tek j√≠zdy",
                description: jizdniRad,
                color: 0x2ecc71
            });

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek j√≠zdy",
                description: `**${jmenoZamestnance}**: J√≠zda ${c} (${lObj.nazev}). Odjezd: ${s}.`,
                color: 0x3498db
            });
            await poslatHlaseniBlackwater(lObj, h, m);
            document.getElementById('st-'+id).style.display='none';
            document.getElementById('ch-'+id).style.display='inline-block';
        }

        async function konec(id, c, l) {
            let p = prompt("Tr≈æba (poƒçet l√≠stk≈Ø):", "0");
            let z = (parseInt(p) || 0) * 5;
            statistiky.trzba += z; statistiky.dokonƒçeno++;

            // Ot√°zka na pr≈Øvodƒç√≠ho
            let pruvodci = null;
            if (confirm("Byl s v√°mi pr≈Øvodƒç√≠?")) {
                // Otev≈ô√≠t modal pro v√Ωbƒõr pr≈Øvodƒç√≠ho
                document.getElementById('pruvodci-modal').style.display = 'block';
                // ƒåekat na v√Ωbƒõr (jednoduch√© ≈ôe≈°en√≠: pou≈æijeme global promƒõnnou)
                await new Promise(resolve => {
                    window.pruvodciCallback = (selected) => {
                        pruvodci = selected;
                        document.getElementById('pruvodci-modal').style.display = 'none';
                        resolve();
                    };
                });
            }

            const pruvodciText = pruvodci ? `Pr≈Øvodƒç√≠: ${pruvodci}` : "Pr≈Øvodƒç√≠: Nep≈ô√≠tomen";

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "J√≠zda dokonƒçena",
                description: `**${jmenoZamestnance}**: J√≠zda ${c} hotova.\n${pruvodciText}`,
                fields: [
                    { name: "Tr≈æba", value: `${z} USD`, inline: true }
                ],
                color: 0x2ecc71
            });

            // Odeslat zpr√°vu pr≈Øvodƒç√≠mu, pokud byl vybr√°n
            if (pruvodci) {
                const pruvodciID = pruvodci.replace(' ', '-');
                const pruvWebhook = WEBHOOK_ZAMESTNANCI[pruvodciID];
                if (pruvWebhook) {
                    await odeslat(pruvWebhook, null, {
                        title: "Slu≈æba pr≈Øvodƒç√≠ho dokonƒçena",
                        description: `**${pruvodci}** slou≈æil na lince **${l}** jako pr≈Øvodƒç√≠.`,
                        fields: [
                            { name: "Prodan√© j√≠zdenky", value: `${p}`, inline: true },
                            { name: "Tr≈æba", value: `${z} USD`, inline: true }
                        ],
                        color: 0x3498db
                    });
                }
            }

            document.getElementById('item-'+id).classList.add('completed-jizda');
            document.getElementById('ch-'+id).disabled = true;
        }

        async function odeslat(url, msg = null, embed = null) {
            const payload = embed ? { embeds: [embed] } : { content: msg };
            return fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        async function poslatHlaseniBlackwater(linkaObj, startH, startM) {
            let tH = startH, tM = startM;
            let nalezenaZastavkaCislo = 0;
            for (let z of linkaObj.zastavky) {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                if(z.s.includes("Blackwater")) {
                    nalezenaZastavkaCislo++;
                    let bwCas = formatCas(tH, tM);
                    let smer = "Saint Denis";
                    if(linkaObj.nazev === "EXPRES TRAIN") smer = (nalezenaZastavkaCislo === 1) ? "Benedict Point" : "Saint Denis";
                    const msg = `üì¢ **INFORMAƒåN√ç TABULE BLACKWATER**\nüìå **${linkaObj.nazev}**\nüïí P≈ô√≠jezd: **${bwCas}**\nüõ§Ô∏è Smƒõr: **${smer}**`;
                    await odeslat(WEBHOOK_BLACKWATER, null, {
                        title: "Informaƒçn√≠ tabule Blackwater",
                        fields: [
                            { name: "Linka", value: linkaObj.nazev, inline: true },
                            { name: "P≈ô√≠jezd", value: bwCas, inline: true },
                            { name: "Smƒõr", value: smer, inline: true }
                        ],
                        color: 0xf39c12
                    });
                }
            }
        }

        async function ukoncitSmenu() {
                            // Nastavit zamƒõstnance na volno a pr√°zdnou trasu
                            if (!window._firestore_imported) {
                                window._firestore_imported = {};
                                window._firestore_imported.db = (await import('./firebase.js')).db;
                                const firestore = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                                window._firestore_imported.doc = firestore.doc;
                                window._firestore_imported.updateDoc = firestore.updateDoc;
                            }
                            await window._firestore_imported.updateDoc(window._firestore_imported.doc(window._firestore_imported.db, "zamestnanci", postavaID), {
                                status: "volno",
                                aktualniTrasa: "-"
                            });
            if(confirm("Ukonƒçit smƒõnu?")) {
                // Uvolnƒõn√≠ lokomotivy
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { db } = await import('./firebase.js');
                await setDoc(doc(db, "lokomotivy", "lokomotiva_1"), { obsazeno: false }, { merge: true });

                // Naƒçten√≠ star√Ωch dat
                const key = postavaID + '_stats';
                const oldData = JSON.parse(localStorage.getItem(key) || '{"dokonƒçeno": 0, "trzba": 0}');
                // Nov√° data
                const newDokonƒçeno = oldData.dokonƒçeno + statistiky.dokonƒçeno;
                const newTrzba = oldData.trzba + statistiky.trzba;
                // Ulo≈æen√≠ nov√Ωch dat
                const newData = { dokonƒçeno: newDokonƒçeno, trzba: newTrzba };
                localStorage.setItem(key, JSON.stringify(newData));
                // Odesl√°n√≠ reportu na zamƒõstnaneck√Ω webhook
                const zamWebhook = WEBHOOK_ZAMESTNANCI[postavaID];
                if (zamWebhook) {
                    await odeslat(zamWebhook, null, {
                        title: "Saint Denis Report zamƒõstnance",
                        description: `**${jmenoZamestnance}**`,
                        fields: [
                            { name: "Naposledy Odjeto Kol", value: `${oldData.dokonƒçeno}` , inline: true },
                            { name: "Posledn√≠ tr≈æba", value: `${oldData.trzba} USD`, inline: true },
                            { name: "Nov√Ω Poƒçet odjet√Ωch kol", value: `${newDokonƒçeno}`, inline: true },
                            { name: "Nov√° tr≈æba", value: `${newTrzba} USD`, inline: true }
                        ],
                        color: 0x3498db
                    });
                }
                // Odesl√°n√≠ hlavn√≠ho reportu
                await odeslat(WEBHOOK_HLAVNI, null, {
                    title: "Konec smƒõny - Report",
                    description: `**${jmenoZamestnance}**`,
                    fields: [
                        { name: "Dokonƒçeno", value: `${statistiky.dokonƒçeno}/${statistiky.celkemTrasy}`, inline: true },
                        { name: "Tr≈æba", value: `${statistiky.trzba} USD`, inline: true }
                    ],
                    color: 0xe74c3c
                });
                location.reload();
            }
        }
        function toggleDetail(id) { const e = document.getElementById(id); e.style.display = (e.style.display==='none')?'block':'none'; }
        function vymazatZaznam() { localStorage.clear(); location.reload(); }

        // Changelog Modal
        window.onload = function() {
            if (!sessionStorage.getItem('changelogShown')) {
                document.getElementById('changelog-modal').style.display = 'block';
                sessionStorage.setItem('changelogShown', 'true');
            }
        };

        function closeChangelog() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        function checkChangelog() {
            const checks = document.querySelectorAll('#changelog-modal input[type="checkbox"]');
            const allChecked = Array.from(checks).every(cb => cb.checked);
            if (allChecked) {
                localStorage.setItem('changelogRead', 'true');
            }
        }
    </script>

    <!-- Pr≈Øvodƒç√≠ Modal -->
    <div id="pruvodci-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('pruvodci-modal').style.display='none';">&times;</span>
            <h2>Vyber pr≈Øvodƒç√≠ho</h2>
            <ul class="pruvodci-list">
                <li onclick="window.pruvodciCallback('Joshue Thorne')">Joshue Thorne</li>
                <li onclick="window.pruvodciCallback('Elizabeth Brown')">Elizabeth Brown</li>
                <li onclick="window.pruvodciCallback('Henry Brown')">Henry Brown</li>
                <li onclick="window.pruvodciCallback('Nicholas Carter')">Nicholas Carter</li>
            </ul>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangelog()">&times;</span>
            <h2>Changelog - Continental Rail Company</h2>
            <table class="changelog-table">
                <thead>
                    <tr>
                        <th>Verze</th>
                        <th>Zmƒõny</th>
                        <th>P≈ôeƒçteno</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2.6</td>
                        <td>Upraven√° trasa Local Train: nov√© ƒçasy mezi stanicemi, p≈ôid√°n pobyt +3 min v Saint Denis (telegramy) a +6 min ve Valentine (vykl√°dka/nakl√°dka). Pozn√°mka k telegram≈Øm a vykl√°dce p≈ôid√°na do detailu trasy.</td>
                        <td><input type="checkbox" id="v2.6" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.5</td>
                        <td>P≈ôid√°na funkce Smluvn√≠ p≈ôeprava: Formul√°≈ô pro zad√°n√≠ typu p≈ôepravy, poƒçtu polo≈æek a pozn√°mek s automatick√Ωm v√Ωpoƒçtem ceny a odesl√°n√≠m reportu.</td>
                        <td><input type="checkbox" id="v2.5" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.4</td>
                        <td>P≈ôid√°ny pozn√°mky k tras√°m: LOCAL TRAIN (≈æ√°dn√° omezen√≠), EXPRES/BULLET TRAIN (omezen√≠ v MacFarlane's Ranch kv≈Øli vlk≈Øm).</td>
                        <td><input type="checkbox" id="v2.4" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.3</td>
                        <td>P≈ôid√°na funkce pr≈Øvodƒç√≠ch: Po dokonƒçen√≠ j√≠zdy v√Ωbƒõr pr≈Øvodƒç√≠ho s odesl√°n√≠m reportu na jeho Discord webhook (slu≈æba, prodan√© j√≠zdenky).</td>
                        <td><input type="checkbox" id="v2.3" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.2</td>
                        <td>Aktualizace tras vlak≈Ø: EXPRES TRAIN (nov√© intervaly bez Oil Fields, s extra ƒçasy pro n√°klad), BULLET TRAIN (nov√° trasa s Olej√°rkou) a LOCAL TRAIN (zkr√°cen√© ƒçasy s extra pro Valentine a Saint Denis).</td>
                        <td><input type="checkbox" id="v2.2" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.1</td>
                        <td>P≈ôid√°ny osobn√≠ reporty zamƒõstnanc≈Ø na Discord s kumulovan√Ωmi statistikami. Ulo≈æen√≠ dat do localStorage pro trval√© sledov√°n√≠.</td>
                        <td><input type="checkbox" id="v2.1" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>1.1</td>
                        <td>Vylep≈°en√Ω vizu√°l s retro fonty a zlat√Ωmi akcenty. P≈ôid√°ny ornamenty a animace.</td>
                        <td><input type="checkbox" id="v1.1" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>1.0</td>
                        <td>Poƒç√°teƒçn√≠ vyd√°n√≠ s v√Ωbƒõrem zamƒõstnanc≈Ø a spr√°vou smƒõn.</td>
                        <td><input type="checkbox" id="v1.0" onchange="checkChangelog()"></td>
                    </tr>
                </tbody>
            </table>
            <button class="rp-button" onclick="closeChangelog()">Zav≈ô√≠t</button>
        </div>
    </div>
</body>
</html>