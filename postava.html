<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pracovn√≠ list - CRC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="book-page">
        <div class="border-decoration">
            <header>
                <h1 id="jmeno-zamestnance">Naƒç√≠t√°n√≠...</h1>
                <div class="ornament">‚ù¶</div>
            </header>

            <div id="hlavni-rozhrani">
                <div class="status-box">
                    <p id="aktualni-stav">Status: Mimo slu≈æbu</p>
                </div>
                <div class="button-container">
                    <button class="rp-button" onclick="zobrazNastaveniSmeny()">Zaƒç√≠t Smƒõnu (Manu√°ln√≠)</button>
                    <button class="rp-button" onclick="zobrazVyberSmeny()">P≈ôebrat smƒõnu (Turnus)</button>
                    <button class="rp-button btn-reset" onclick="vymazatZaznam()">Resetovat data</button>
                </div>
            </div>

            <div id="vyber-turnusu" style="display:none;">
                <h2 class="section-label">Volba slu≈æby</h2>
                <div class="button-container">
                    <button class="rp-button" onclick="nastavitTurnus('RANN√ç')">¬ß RANN√ç (05:00 - 15:00)</button>
                    <button class="rp-button" onclick="nastavitTurnus('ODPOLEDN√ç')">¬ß ODPOLEDN√ç (15:00 - 22:00)</button>
                    <button class="rp-button" onclick="nastavitTurnus('NOƒåN√ç')">¬ß NOƒåN√ç (22:00 - 05:00)</button>
                    <button class="back-link" onclick="zpet()">‚Üê Zpƒõt</button>
                </div>
            </div>

            <div id="vyber-linky" style="display:none;">
                <h2 class="section-label">Nastaven√≠ j√≠zdy</h2>
                <div class="button-container">
                    <label class="rp-label">Linka:</label>
                    <select id="select-linka" class="rp-select">
                        <option value="0">Expres Train (Dlouh√° trasa)</option>
                        <option value="1">Bullet Train (Rychl√≠k)</option>
                        <option value="2">Local Train (Region√°ln√≠)</option>
                    </select>
                    <label class="rp-label">Poƒçet kol:</label>
                    <input type="number" id="input-kola" class="rp-input" min="1" value="1">
                    <label class="rp-label">Odjezd za (minut):</label>
                    <input type="number" id="input-odklad" class="rp-input" min="0" value="0">
                    <button class="rp-button" onclick="zah√°jitManualniSmenu()">Potvrdit a vyjet</button>
                    <button class="back-link" onclick="zpet()">‚Üê Zpƒõt</button>
                </div>
            </div>

            <div id="jizdni-rad-smeny" style="display:none;">
                <h2 class="section-label">J√≠zdn√≠ ≈ô√°d</h2>
                <div id="vypis-linek" class="jizdy-list"></div>
                <button id="finish-btn" class="rp-button btn-finish-shift" onclick="ukoncitSmenu()">UKONƒåIT CELOU SMƒöNU</button>
            </div>

            <footer><a href="index.html" class="back-link">Zpƒõt do seznamu</a></footer>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const postavaID = params.get('id');
        const jmenoZamestnance = postavaID ? postavaID.replace(/-/g, ' ') : "Nezn√°m√Ω";
        document.getElementById('jmeno-zamestnance').innerText = jmenoZamestnance;

        const WEBHOOK_HLAVNI = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
        const WEBHOOK_BLACKWATER = "https://discord.com/api/webhooks/1463245037834862616/M_myizEOqBJjE84_5MKqNQdRlY4S1P6EHBA3JnYxOw2mdYYn0kt609sc8MIz1v3e4PkV";

        const WEBHOOK_JIZDNI_RAD = "https://discord.com/api/webhooks/1462391755864277033/mQ1n6EsyC-yEuEc7hZTYsm8Jt9VjnUGr-jPVM2qjvVSSkisoS2Cpl1DSi1Oe7lUnBd6J";

        const WEBHOOK_ZAMESTNANCI = {
            'Joshue-Thorne': "https://discord.com/api/webhooks/1465056082752704603/RLXTppqZ_ANNJ58G7SAnJt9jzupt1ySDpeuz3TcgZUnGIoWeEYH4iRe9uAgw2pugZUbo",
            'Elizabeth-Brown': "https://discord.com/api/webhooks/1465055695148945479/XbFSoeTQ7uvPyO_9dzfaRzXU8Vs_A0rxEtj2KhD14cmzhB6CE0lJyk0eEtrpF9MBgRwD",
            'Henry-Brown': "https://discord.com/api/webhooks/1465055928955965726/b2yx37bmObtgQkbuh-8RLX4OmGuNLb55T_ZoqKnP33wV22tvv_Hkq2viyb5H7gbt3b6R",
            'Nicholas-Carter': "https://discord.com/api/webhooks/1465055817861435568/4ewqq4dEVmRgdcj86YCudaB5l34CMg8BiMHHvt_T-mfsUJSQ3T_ofibyBKK29pqqvEP-"
        };

        let statistiky = { dokonƒçeno: 0, celkemTrasy: 0, trzba: 0 };
        
        // Data upravena podle tv√Ωch nejnovƒõj≈°√≠ch tras a k≈ôi≈æov√°n√≠ v Olej√°rnƒõ
        const linkyData = [
            { 
                nazev: "EXPRES TRAIN", 
                doba: 67, // Upraven√° doba podle nov√Ωch interval≈Ø
                zastavky: [
                    {s: "Saint Denis", t: 0}, {s: "Van Horn", t: 3}, {s: "Annesburg", t: 8}, 
                    {s: "Bacchus Station", t: 4}, {s: "Wallace Station", t: 4}, {s: "Riggs Station", t: 2}, 
                    {s: "Blackwater", t: 2}, {s: "MacFarlane's Ranch", t: 4}, {s: "Armadillo", t: 4}, 
                    {s: "Mercer Station", t: 2}, {s: "Benedict Point", t: 12}, {s: "Mercer Station", t: 3}, 
                    {s: "Armadillo", t: 2}, {s: "MacFarlane's Ranch", t: 4}, {s: "Blackwater", t: 4}, 
                    {s: "Flatneck", t: 3}, {s: "Rhodes", t: 3}, {s: "Saint Denis", t: 3}
                ] 
            },
            { 
                nazev: "BULLET TRAIN", 
                doba: 37, // Upraven√° doba podle nov√Ωch interval≈Ø
                zastavky: [
                    {s: "Saint Denis", t: 0}, {s: "Oil Fields", t: 4}, {s: "Valentine", t: 2}, {s: "Flatneck Station", t: 2}, 
                    {s: "Montana River", t: 4}, {s: "MacFarlane's Ranch", t: 8}, {s: "Blackwater", t: 3}, {s: "Flatneck Station", t: 2}, 
                    {s: "Rhodes", t: 3}, {s: "Saint Denis", t: 9}
                ] 
            },
            { 
                nazev: "LOCAL TRAIN", 
                doba: 25, // Upraven√° doba podle nov√Ωch interval≈Ø
                zastavky: [
                    {s: "Saint Denis", t: 0}, {s: "Rhodes", t: 3}, {s: "Valentine", t: 9}, {s: "Oil Fields", t: 2}, 
                    {s: "Emerald Ranch", t: 2}, {s: "Saint Denis", t: 9}
                ] 
            }
        ];

        const SMENY_CONFIG = {
            'RANN√ç': { start: 300, konec: 900 },    // 05:00 - 15:00
            'ODPOLEDN√ç': { start: 900, konec: 1320 }, // 15:00 - 22:00
            'NOƒåN√ç': { start: 1320, konec: 1740 }   // 22:00 - 05:00
        };

        function formatCas(h, m) {
            let hh = h; while (hh >= 24) hh -= 24;
            return (hh < 10 ? "0"+hh : hh) + ":" + (m < 10 ? "0"+m : m);
        }

        function zobrazNastaveniSmeny() { 
            document.getElementById('hlavni-rozhrani').style.display='none'; 
            document.getElementById('vyber-linky').style.display='block'; 
        }

        function zobrazVyberSmeny() {
            document.getElementById('hlavni-rozhrani').style.display='none';
            document.getElementById('vyber-turnusu').style.display='block';
        }

        function zpet() { location.reload(); }

        async function nastavitTurnus(typ) {
            const config = SMENY_CONFIG[typ];
            let aktualniCasVMinutach = config.start;
            const konecSmenyVMinutach = config.konec;
            
            document.getElementById('vyber-turnusu').style.display = 'none';
            document.getElementById('jizdni-rad-smeny').style.display = 'block';
            let v = document.getElementById('vypis-linek');
            v.innerHTML = "";
            
            statistiky.celkemTrasy = 0;
            let indexLinky = 0;

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek smƒõny",
                description: `**${jmenoZamestnance}** nastupuje na turnus: **${typ}**.`,
                color: 0x3498db
            });

            while (aktualniCasVMinutach + 20 < konecSmenyVMinutach) {
                let linka = linkyData[indexLinky % linkyData.length];
                if (aktualniCasVMinutach + linka.doba > konecSmenyVMinutach) break;

                let startH = Math.floor(aktualniCasVMinutach / 60) % 24;
                let startM = aktualniCasVMinutach % 60;

                v.innerHTML += vytvorRadekJizdy(linka, statistiky.celkemTrasy + 1, startH, startM);
                
                aktualniCasVMinutach += linka.doba + 10; // Doba j√≠zdy + 10min pauza v Saint Denis
                statistiky.celkemTrasy++;
                indexLinky++;
            }
        }

        async function zah√°jitManualniSmenu() {
            const index = document.getElementById('select-linka').value;
            const kola = parseInt(document.getElementById('input-kola').value) || 1;
            const odklad = parseInt(document.getElementById('input-odklad').value) || 0;
            const d = new Date(new Date().getTime() + (odklad * 60000));
            
            document.getElementById('vyber-linky').style.display='none'; 
            document.getElementById('jizdni-rad-smeny').style.display='block';
            
            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek manu√°ln√≠ smƒõny",
                description: `**${jmenoZamestnance}** zahajuje manu√°ln√≠ smƒõnu (${linkyData[index].nazev}).`,
                color: 0x3498db
            });
            
            let v = document.getElementById('vypis-linek'); v.innerHTML = "";
            let h = d.getHours(), m = d.getMinutes();
            for(let i=1; i<=kola; i++) {
                v.innerHTML += vytvorRadekJizdy(linkyData[index], i, h, m);
                statistiky.celkemTrasy++;
                m += linkyData[index].doba + 10; while(m >= 60) { m -= 60; h++; }
            }
        }

        function vytvorRadekJizdy(l, c, h, m) {
            const id = "j-" + Math.random().toString(36).substr(2, 5);
            const sV = formatCas(h, m);
            let it = `<table class="itinerar-table">`;
            let tH = h, tM = m;
            l.zastavky.forEach(z => {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                it += `<tr><td>${z.s}</td><td class="it-cas">${formatCas(tH, tM)}</td></tr>`;
            });
            it += `</table>`;
            return `<div class="jizda-item" id="item-${id}">
                <p><strong>${c}. ${l.nazev} (${sV})</strong></p>
                <button class="detail-btn" onclick="toggleDetail('${id}')">TRASA</button>
                <button class="start-btn" id="st-${id}" onclick="start('${id}', '${c}', '${sV}', '${formatCas(tH, tM)}', ${JSON.stringify(l).replace(/"/g, '&quot;')}, ${h}, ${m})">ZAƒå√çT J√çZDU</button>
                <button class="check-btn" id="ch-${id}" style="display:none;" onclick="konec('${id}', '${c}', '${l.nazev}')">HOTOVO ‚úî</button>
                <div id="${id}" class="jizda-detail" style="display:none;">${it}</div>
            </div>`;
        }

        async function start(id, c, s, k, lObj, h, m) {
            // Pozn√°mky pro stanice s extra ƒçasem
            const extraNotes = {
                'Annesburg': ' (n√°klad + vykl√°dka telegramu)',
                'Benedict Point': ' (n√°klad + vykl√°dka telegramu)',
                "MacFarlane's Ranch": ' (n√°klad + vykl√°dka telegramu)',
                'Saint Denis': ' (n√°klad + vykl√°dka telegramu)',
                'Valentine': ' (n√°klad + vykl√°dka telegramu)'
            };

            // Vytvo≈ôen√≠ textu j√≠zdn√≠ho ≈ô√°du
            let jizdniRad = `**Strojvedouc√≠:** ${jmenoZamestnance}\n**Linka:** ${lObj.nazev}\n**J√≠zda ƒç.** ${c}\n**Odjezd:** ${s}\n\n**Itiner√°≈ô:**\n`;
            let tH = h, tM = m;
            lObj.zastavky.forEach(z => {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                jizdniRad += `- ${z.s}${extraNotes[z.s] || ''}: ${formatCas(tH, tM)}\n`;
            });

            await odeslat(WEBHOOK_JIZDNI_RAD, null, {
                title: "üöÇ J√≠zdn√≠ ≈ô√°d - Zaƒç√°tek j√≠zdy",
                description: jizdniRad,
                color: 0x2ecc71
            });

            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "Zaƒç√°tek j√≠zdy",
                description: `**${jmenoZamestnance}**: J√≠zda ${c} (${lObj.nazev}). Odjezd: ${s}.`,
                color: 0x3498db
            });
            await poslatHlaseniBlackwater(lObj, h, m);
            document.getElementById('st-'+id).style.display='none';
            document.getElementById('ch-'+id).style.display='inline-block';
        }

        async function konec(id, c, l) {
            let p = prompt("Tr≈æba (poƒçet l√≠stk≈Ø):", "0");
            let z = (parseInt(p) || 0) * 5;
            statistiky.trzba += z; statistiky.dokonƒçeno++;
            await odeslat(WEBHOOK_HLAVNI, null, {
                title: "J√≠zda dokonƒçena",
                description: `**${jmenoZamestnance}**: J√≠zda ${c} hotova.`,
                fields: [
                    { name: "Tr≈æba", value: `${z} USD`, inline: true }
                ],
                color: 0x2ecc71
            });
            document.getElementById('item-'+id).classList.add('completed-jizda');
            document.getElementById('ch-'+id).disabled = true;
        }

        async function odeslat(url, msg = null, embed = null) {
            const payload = embed ? { embeds: [embed] } : { content: msg };
            return fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        async function poslatHlaseniBlackwater(linkaObj, startH, startM) {
            let tH = startH, tM = startM;
            let nalezenaZastavkaCislo = 0;
            for (let z of linkaObj.zastavky) {
                tM += z.t; while(tM >= 60) { tM -= 60; tH++; }
                if(z.s.includes("Blackwater")) {
                    nalezenaZastavkaCislo++;
                    let bwCas = formatCas(tH, tM);
                    let smer = "Saint Denis";
                    if(linkaObj.nazev === "EXPRES TRAIN") smer = (nalezenaZastavkaCislo === 1) ? "Benedict Point" : "Saint Denis";
                    const msg = `üì¢ **INFORMAƒåN√ç TABULE BLACKWATER**\nüìå **${linkaObj.nazev}**\nüïí P≈ô√≠jezd: **${bwCas}**\nüõ§Ô∏è Smƒõr: **${smer}**`;
                    await odeslat(WEBHOOK_BLACKWATER, null, {
                        title: "Informaƒçn√≠ tabule Blackwater",
                        fields: [
                            { name: "Linka", value: linkaObj.nazev, inline: true },
                            { name: "P≈ô√≠jezd", value: bwCas, inline: true },
                            { name: "Smƒõr", value: smer, inline: true }
                        ],
                        color: 0xf39c12
                    });
                }
            }
        }

        async function ukoncitSmenu() {
            if(confirm("Ukonƒçit smƒõnu?")) {
                // Naƒçten√≠ star√Ωch dat
                const key = postavaID + '_stats';
                const oldData = JSON.parse(localStorage.getItem(key) || '{"dokonƒçeno": 0, "trzba": 0}');
                
                // Nov√° data
                const newDokonƒçeno = oldData.dokonƒçeno + statistiky.dokonƒçeno;
                const newTrzba = oldData.trzba + statistiky.trzba;
                
                // Ulo≈æen√≠ nov√Ωch dat
                const newData = { dokonƒçeno: newDokonƒçeno, trzba: newTrzba };
                localStorage.setItem(key, JSON.stringify(newData));
                
                // Odesl√°n√≠ reportu na zamƒõstnaneck√Ω webhook
                const zamWebhook = WEBHOOK_ZAMESTNANCI[postavaID];
                if (zamWebhook) {
                    await odeslat(zamWebhook, null, {
                        title: "Saint Denis Report zamƒõstnance",
                        description: `**${jmenoZamestnance}**`,
                        fields: [
                            { name: "Naposledy Odjeto Kol", value: `${oldData.dokonƒçeno}`, inline: true },
                            { name: "Posledn√≠ tr≈æba", value: `${oldData.trzba} USD`, inline: true },
                            { name: "Nov√Ω Poƒçet odjet√Ωch kol", value: `${newDokonƒçeno}`, inline: true },
                            { name: "Nov√° tr≈æba", value: `${newTrzba} USD`, inline: true }
                        ],
                        color: 0x3498db
                    });
                }
                
                // Odesl√°n√≠ hlavn√≠ho reportu
                await odeslat(WEBHOOK_HLAVNI, null, {
                    title: "Konec smƒõny - Report",
                    description: `**${jmenoZamestnance}**`,
                    fields: [
                        { name: "Dokonƒçeno", value: `${statistiky.dokonƒçeno}/${statistiky.celkemTrasy}`, inline: true },
                        { name: "Tr≈æba", value: `${statistiky.trzba} USD`, inline: true }
                    ],
                    color: 0xe74c3c
                });
                location.reload();
            }
        }
        function toggleDetail(id) { const e = document.getElementById(id); e.style.display = (e.style.display==='none')?'block':'none'; }
        function vymazatZaznam() { localStorage.clear(); location.reload(); }

        // Changelog Modal
        window.onload = function() {
            if (!sessionStorage.getItem('changelogShown')) {
                document.getElementById('changelog-modal').style.display = 'block';
                sessionStorage.setItem('changelogShown', 'true');
            }
        };

        function closeChangelog() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        function checkChangelog() {
            const checks = document.querySelectorAll('#changelog-modal input[type="checkbox"]');
            const allChecked = Array.from(checks).every(cb => cb.checked);
            if (allChecked) {
                localStorage.setItem('changelogRead', 'true');
            }
        }
    </script>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangelog()">&times;</span>
            <h2>Changelog - Continental Rail Company</h2>
            <table class="changelog-table">
                <thead>
                    <tr>
                        <th>Verze</th>
                        <th>Zmƒõny</th>
                        <th>P≈ôeƒçteno</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2.2</td>
                        <td>Aktualizace tras vlak≈Ø: EXPRES TRAIN (nov√© intervaly bez Oil Fields, s extra ƒçasy pro n√°klad), BULLET TRAIN (nov√° trasa s Olej√°rkou) a LOCAL TRAIN (zkr√°cen√© ƒçasy s extra pro Valentine a Saint Denis).</td>
                        <td><input type="checkbox" id="v2.2" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>2.1</td>
                        <td>P≈ôid√°ny osobn√≠ reporty zamƒõstnanc≈Ø na Discord s kumulovan√Ωmi statistikami. Ulo≈æen√≠ dat do localStorage pro trval√© sledov√°n√≠.</td>
                        <td><input type="checkbox" id="v2.1" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>1.1</td>
                        <td>Vylep≈°en√Ω vizu√°l s retro fonty a zlat√Ωmi akcenty. P≈ôid√°ny ornamenty a animace.</td>
                        <td><input type="checkbox" id="v1.1" onchange="checkChangelog()"></td>
                    </tr>
                    <tr>
                        <td>1.0</td>
                        <td>Poƒç√°teƒçn√≠ vyd√°n√≠ s v√Ωbƒõrem zamƒõstnanc≈Ø a spr√°vou smƒõn.</td>
                        <td><input type="checkbox" id="v1.0" onchange="checkChangelog()"></td>
                    </tr>
                </tbody>
            </table>
            <button class="rp-button" onclick="closeChangelog()">Zav≈ô√≠t</button>
        </div>
    </div>
</body>
</html>